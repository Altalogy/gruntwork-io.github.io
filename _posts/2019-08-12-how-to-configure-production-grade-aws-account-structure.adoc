= How to configure a production-grade AWS account structure
:type: guide
:description: Learn about why you need multiple AWS accounts, AWS Organizations, IAM Users, IAM Roles, IAM Policies, CloudTrail, and more.
:image: ../assets/img/guides/aws-account/aws-logo.png
:tags: aws, terraform
:toc:
:toc-placement!:

// GitHub specific settings. See https://gist.github.com/dcode/0cfbf2699a1fe9b46ff04c41721dda74 for details.
ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
endif::[]

toc::[]

== Intro

This guide will walk you through the process of configuring a production-grade AWS account structure.

=== What is an AWS account structure?

https://aws.amazon.com[Amazon Web Services (AWS)] is the world's most popular an on-demand cloud computing platform,
with a larger market share than the next three major cloud providers combined (Azure, GCP, IBM), more than 1 million
customers, and over 60 data centers in 20 regions around the world. To use AWS, you sign up for an AWS account. To use
AWS in production, you have to create an _AWS account structure_ that consists of multiple inter-connected AWS accounts.

Configuring an AWS account structure serves three primary purposes:

Isolation::
You use separate AWS accounts to isolate different environments from each other. For example, putting your staging and
production environments in separate AWS accounts ensures that if an attacker manages to break into staging, they still
have no access whatsoever to production. Likewise, this isolation ensures a developer making changes in staging is
less likely to accidentally break something in production.

Authentication and authorization::
If you configure your AWS account structure correctly, you'll be able to manage all user accounts in one place, making
it easier to enforce password policies, multi-factor authentication, key rotation, and other security requirements.
Using multiple AWS accounts also makes it easier to have fine-grained control over what permissions each developer gets
in each environment.

Auditing and reporting::
A properly configured AWS account structure will allow you to maintain an audit trail off all the changes happening in
all your environments, check if you're adhering to compliance requirements, and detect anomalies. Moreover, you'll be
able to have consolidated billing, with a single bill for all of your AWS accounts, showing cost breakdowns by account,
service, tag, etc.

=== What you'll learn in this guide

This guide consists of four main sections:

<<core_concepts>>::
An overview of the core concepts you need to understand to set up an AWS account structure, including AWS
Organizations, IAM Users, IAM Roles, IAM Groups, CloudTrail, and more.

<<production_grade_design>>::
An overview of how to configure a secure, scalable, highly available AWS account structure that you can rely on in
production. To get a sense of what production-grade means, check out the production-grade infrastructure checklist.

// TODO: link to checklist

<<deployment_walkthrough>>::
A step-by-step guide to configuring a production-grade AWS account structure using code from the Gruntwork Service
Catalog.

<<next_steps>>::
What to do once you've got your AWS account structure configured.

Feel free to read the guide start to finish or skip around to whatever part interests you!

[[core_concepts]]
== Core concepts

=== Creating an AWS account

Creating a single AWS account is easy:

. Go to https://aws.amazon.com
. Click the "Sign Up" button
. Fill in your contact and billing details
. This will create a new AWS account for you with a unique
  _https://docs.aws.amazon.com/IAM/latest/UserGuide/console_account-alias.html[AWS account ID]_ (a 12 digit code).

You'll now be logged into your new AWS account as the root user.

=== Root user

Each AWS account has exactly one _root user_:

User name::
  The email address you provide when creating a new AWS account becomes the user name of your root user. This email
  address must be unique across ALL AWS accounts globally, so you can't use the same email address to create multiple
  AWS accounts.

Console password::
  When creating a new AWS account, you will create a _console password_ that, along with the root user's user name,
  you can use to login to the AWS console.

Logging into the AWS console::
  After the initial sign up, if you wish to login as the root user, you have to go to
  https://console.aws.amazon.com and login using the root user's email address and password.

Multi-Factor Authentication (MFA)::
  You can optionally enable
  _https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_mfa.html[Multi-Factor Authentication (MFA)]_ for the
  root user (*strongly recommended*), which will require you to provide not only the user name and password when
  logging in, but also a temporary, one-time token generated by either a virtual or physical MFA device (e.g., the
  Google Authenticator app, RSA key fob, or a YubiKey). This adds a strong second layer of security for your root user,
  as logging in now requires both something you know (the user name and password) and something you have (the
  virtual or physical MFA device).

Root permissions::
  The root user has access permissions to _everything_ in your AWS account, and, by design, there's almost no way to
  limit those permissions (similar to the root user on an operating system). If your root user account
  gets compromised, the attacker will likely be able to take over everything in your account. Therefore, you typically
  only use the root user during initial setup to create IAM users with more limited permissions (more on IAM users in
  the next section), and then you'll likely never touch the root user account again.

=== IAM users

In AWS, you use _https://aws.amazon.com/iam/[Identity and Access Management (IAM)]_ to manage access to your AWS
account. One of the things you can do in IAM is create an
_https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users.html[IAM user]_, which is a user account with a name and
credentials. You can login to AWS as this IAM user and, depending on the permissions granted to this user (we'll
discuss permissions in the next section), access various resources in your AWS account.

User name::
  Every IAM user in your AWS account must have a unique _user name_.

Console password::
  Each IAM user can optionally have a _console password_. The user name and console password allows you to login as an
  IAM user to your AWS account in a web browser by using the IAM user sign-in URL.

IAM user sign-in URL::
  Every AWS account has a unique
  _https://docs.aws.amazon.com/IAM/latest/UserGuide/getting-started_how-users-sign-in.html[IAM user sign-in URL]_. Note
  that to login as an IAM user, you do NOT go to https://console.aws.amazon.com, as that's solely the sign-in URL for
  root users. Instead, IAM users will need to use a sign-in URL of the form
  `https://<ID_OR_ALIAS>.signin.aws.amazon.com/console`, where `ID_OR_ALIAS` is either your AWS account ID (e.g.,
  `https://111122223333.signin.aws.amazon.com/console` or a
  _https://docs.aws.amazon.com/IAM/latest/UserGuide/console_account-alias.html[custom account alias]_ that you pick for
  your AWS account (e.g., `https://my-custom-alias.signin.aws.amazon.com/console`). Whenever you create a new IAM user
  (including when you're using a root user to create your very first IAM user), you will need to remember to send that
  IAM user their user name, console password, and the IAM user sign-in URL.

Access keys::
  Each IAM user can optionally have a set of
  _https://docs.aws.amazon.com/general/latest/gr/aws-sec-cred-types.html#access-keys-and-secret-access-keys[access keys]_,
  which are the credentials you use to login to your AWS account programmatically (e.g., on the command line or when
  making API calls). Access keys consist of two parts: an access key ID (for example, `AKIAIOSFODNN7EXAMPLE`) and a
  secret access key (for example, `wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY`).

Multi-Factor Authentication (MFA)::
  Each IAM user can optionally enable
  https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_mfa.html[Multi-Factor Authentication (MFA)] (*strongly
  recommended*), which will require you to provide not only the user name and console password when logging in, but
  also a temporary, one-time token generated by either a virtual or physical MFA device (e.g., the Google Authenticator
  app, RSA key fob, or a YubiKey). This adds a strong second layer of security for your IAM user, as logging in now
  requires both something you know (the user name and password) and something you have (the virtual or physical MFA
  device). Note that, by default, if you enable MFA for an IAM user, the MFA token will only be required when logging
  in with the user name and console password in your web browser; you will NOT be required to provide an MFA token when
  logging in with access keys. To require MFA tokens for all programmatic access (i.e., all access with access keys),
  you will need to use IAM policies, which are described later.

Password policy::
  You can configure a
  _https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_passwords_account-policy.html[password policy]_
  in your AWS account to enforce requirements on console passwords, such as minimum length, use of special characters,
  and password expiration.

=== IAM policies

TODO

=== IAM groups

TODO

=== IAM roles

TODO

=== Creating multiple AWS accounts with AWS Organizations

TODO

=== Federated authentication

TODO

=== CloudTrail

TODO

=== AWS Config

TODO

=== AWS Security Hub

TODO

=== AWS Shield

TODO

[[production_grade_design]]
== Production-grade design

TODO

- Create master account
- Use AWS Orgs to create multiple child accounts: security, dev, stage, prod, shared-services
- Lock down the root user
- Create a set of IAM users in security. Alternatively, use federated auth with one set of users in an IdP.
    - Each IAM user needs self-mgmt permissions at the minimum
- IAM roles in other accounts
    - Use to give users access to those accounts
    - Use to give permissions to services (e.g., EC2, EKS) in those accounts
    - Require MFA for all but machine user IAM roles
- Create IAM groups that give access to certain roles
- Assign IAM users to those IAM groups
- Delete default VPCs / SGs
- Enable CloudTrail in each account
- Enable AWS Config in each account
- Enable AWS Security Hub in each account
- Enable AWS Shield in each account
- Manage domain names? KMS keys?

=== Lock down the root user

Therefore, we *strongly* recommend the following:

- Strong password. Store in secrets manager of just one trusted admin at your company.
- Enable MFA
- Delete access keys
- Don't use the root user for anything again

=== Delete default VPC and SGs in prod

- Cloud Nuke

[[deployment_walkthrough]]
== Deployment walkthrough

TODO

- Switching between accounts
- Authenticating on the web
- Authenticating on the CLI
- Use unique email address for each user; see Google trick with the `+` thing.
- Reset root user password with AWS Org

[[next_steps]]
== Next steps

TODO
