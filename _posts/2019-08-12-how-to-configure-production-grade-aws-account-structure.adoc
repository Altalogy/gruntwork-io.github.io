= How to configure a production-grade AWS account structure
:type: guide
:description: Learn about why you need multiple AWS accounts, AWS Organizations, IAM Users, IAM Roles, IAM Policies, CloudTrail, and more.
:image: ../assets/img/guides/aws-account/aws-logo.png
:tags: aws, terraform
:toc:
:toc-placement!:

// GitHub specific settings. See https://gist.github.com/dcode/0cfbf2699a1fe9b46ff04c41721dda74 for details.
ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
endif::[]

toc::[]

== Intro

This guide will walk you through the process of configuring a production-grade AWS account structure, including how to
manage multiple environments, users, permissions, audit logging, and more.

=== What is an AWS account structure?

https://aws.amazon.com[Amazon Web Services (AWS)] is the world's most popular an on-demand cloud computing platform,
with a larger market share than the next three major cloud providers combined (Azure, GCP, IBM), more than 1 million
customers, and over 60 data centers in 20 regions around the world. To use AWS, you sign up for an AWS account. To use
AWS in production, you have to create an _AWS account structure_ that consists of multiple inter-connected AWS accounts.

Configuring an AWS account structure serves three primary purposes:

Isolation::
  You use separate AWS accounts to isolate different environments from each other. For example, putting your staging and
  production environments in separate AWS accounts ensures that if an attacker manages to break into staging, they still
  have no access whatsoever to production. Likewise, this isolation ensures a developer making changes in staging is
  less likely to accidentally break something in production.

Authentication and authorization::
  If you configure your AWS account structure correctly, you'll be able to manage all user accounts in one place, making
  it easier to enforce password policies, multi-factor authentication, key rotation, and other security requirements.
  Using multiple AWS accounts also makes it easier to have fine-grained control over what permissions each developer
  gets in each environment.

Auditing and reporting::
  A properly configured AWS account structure will allow you to maintain an audit trail off all the changes happening in
  all your environments, check if you're adhering to compliance requirements, and detect anomalies. Moreover, you'll be
  able to have consolidated billing, with a single bill for all of your AWS accounts, showing cost breakdowns by
  account, service, tag, etc.

=== What you'll learn in this guide

This guide consists of four main sections:

<<core_concepts>>::
  An overview of the core concepts you need to understand to set up an AWS account structure, including AWS
  Organizations, IAM Users, IAM Roles, IAM Groups, CloudTrail, and more.

<<production_grade_design>>::
  An overview of how to configure a secure, scalable, highly available AWS account structure that you can rely on in
  production. To get a sense of what production-grade means, check out the production-grade infrastructure checklist.

// TODO: link to checklist

<<deployment_walkthrough>>::
  A step-by-step guide to configuring a production-grade AWS account structure using code from the Gruntwork Service
  Catalog.

<<next_steps>>::
  What to do once you've got your AWS account structure configured.

Feel free to read the guide start to finish or skip around to whatever part interests you!

[[core_concepts]]
== Core concepts

// TODO: topics to consider adding in the future
// AWS Security Hub
// Amazon Inspector
// Access logging in S3, ELBs, etc
// AWS Shield
// AWS WAF
// Amazon Macie

=== AWS account

To use AWS, you must create an AWS account. You do this by signing up at https://aws.amazon.com. Once you've created
an account, it will get a unique
_https://docs.aws.amazon.com/IAM/latest/UserGuide/console_account-alias.html[AWS account ID]_ (a 12 digit code) and
you'll be logged into your new AWS account as the root user.

=== Root user

Each AWS account has exactly one _root user_:

User name::
  The email address you provide when creating a new AWS account becomes the user name of your root user. This email
  address must be unique across ALL AWS accounts globally, so you can't use the same email address to create multiple
  AWS accounts.

Console password::
  When creating a new AWS account, you will create a _console password_ that, along with the root user's user name,
  you can use to login to the AWS console.

Logging into the AWS console::
  After the initial sign up, if you wish to login as the root user, you have to go to
  https://console.aws.amazon.com and login using the root user's email address and password.

Multi-Factor Authentication (MFA)::
  You can optionally enable
  _https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_mfa.html[Multi-Factor Authentication (MFA)]_ for the
  root user (*strongly recommended*), which will require you to provide not only the user name and password when
  logging in, but also a temporary, one-time token generated by either a virtual or physical MFA device (e.g., the
  Google Authenticator app, RSA key fob, or a YubiKey). This adds a strong second layer of security for your root user,
  as logging in now requires both something you know (the user name and password) and something you have (the
  virtual or physical MFA device).

Root permissions::
  The root user has access permissions to _everything_ in your AWS account, and, by design, there's almost no way to
  limit those permissions (similar to the root user on an operating system). If your root user account
  gets compromised, the attacker will likely be able to take over everything in your account. Therefore, you typically
  only use the root user during initial setup to create IAM users with more limited permissions (more on IAM users in
  the next section), and then you'll likely never touch the root user account again.

=== IAM users

In AWS, you use _https://aws.amazon.com/iam/[Identity and Access Management (IAM)]_ to manage access to your AWS
account. One of the things you can do in IAM is create an
_https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users.html[IAM user]_, which is a user account a human being can
use to access an AWS account.

User name::
  Every IAM user in your AWS account must have a unique _user name_.

Console password::
  Each IAM user can optionally have a _console password_. The user name and console password allows you to login as an
  IAM user to your AWS account in a web browser by using the IAM user sign-in URL.

IAM user sign-in URL::
  Every AWS account has a unique
  _https://docs.aws.amazon.com/IAM/latest/UserGuide/getting-started_how-users-sign-in.html[IAM user sign-in URL]_. Note
  that to login as an IAM user, you do NOT go to https://console.aws.amazon.com, as that's solely the sign-in URL for
  root users. Instead, IAM users will need to use a sign-in URL of the form
  `\https://<ID_OR_ALIAS>.signin.aws.amazon.com/console`, where `ID_OR_ALIAS` is either your AWS account ID (e.g.,
  `\https://111122223333.signin.aws.amazon.com/console` or a
  _https://docs.aws.amazon.com/IAM/latest/UserGuide/console_account-alias.html[custom account alias]_ that you pick for
  your AWS account (e.g., `\https://my-custom-alias.signin.aws.amazon.com/console`). Whenever you create a new IAM user
  (including when you're using a root user to create your very first IAM user), you will need to remember to send that
  IAM user their user name, console password, and the IAM user sign-in URL.

Access keys::
  Each IAM user can optionally have a set of
  _https://docs.aws.amazon.com/general/latest/gr/aws-sec-cred-types.html#access-keys-and-secret-access-keys[access keys]_,
  which are the credentials you use to login to your AWS account programmatically (e.g., on the command line or when
  making API calls). Access keys consist of two parts: an access key ID (for example, `AKIAIOSFODNN7EXAMPLE`) and a
  secret access key (for example, `wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY`).

Multi-Factor Authentication (MFA)::
  Each IAM user can optionally enable
  https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_mfa.html[Multi-Factor Authentication (MFA)] (*strongly
  recommended*), which will require you to provide not only the user name and console password when logging in, but
  also a temporary, one-time token generated by either a virtual or physical MFA device (e.g., the Google Authenticator
  app, RSA key fob, or a YubiKey). This adds a strong second layer of security for your IAM user, as logging in now
  requires both something you know (the user name and password) and something you have (the virtual or physical MFA
  device). Note that, by default, if you enable MFA for an IAM user, the MFA token will only be required when logging
  in with the user name and console password in your web browser; you will NOT be required to provide an MFA token when
  logging in with access keys. To require MFA tokens for all programmatic access (i.e., all access with access keys),
  you will need to use IAM policies, which are described later.

Password policy::
  You can configure a
  _https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_passwords_account-policy.html[password policy]_
  in your AWS account to enforce requirements on console passwords, such as minimum length, use of special characters,
  and password expiration.

Permissions::
  By default, a new IAM user does not have permissions to do anything in the AWS account
  (https://en.wikipedia.org/wiki/Principle_of_least_privilege[principle of least privilege]). In order to grant this
  user permissions, you will need to use IAM policies, which are the topic of the next section.

=== IAM policies

You can use _https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies.html[IAM policies]_ to define permissions
in your AWS account.

IAM policy basics::
  Each IAM policy is a JSON document that consists of one or more _statements_, where each statement can allow or deny
  specific _principals_ (e.g., IAM users) to perform specific _actions_ (e.g., `ec2:StartInstances`, `s3:GetObject`) on
  specific _resources_ (e.g., EC2 instances, S3 buckets). Here's an example IAM policy that allows an IAM user named
  `Bob` to perform `s3:GetObject` (i.e., download from S3) any files in an S3 bucket called `examplebucket`:
+
[source,json]
----
{
  "Version":"2012-10-17",
  "Statement":[
    {
      "Effect":"Allow",
      "Principal": {"AWS": ["arn:aws:iam::111122223333:user/Bob"]},
      "Action":["s3:GetObject"],
      "Resource":"arn:aws:s3:::examplebucket/*"
    }
  ]
}
----

Managed policies::
  Each AWS account comes with a number of
  _https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_managed-vs-inline.html[managed policies]_, which
  are pre-defined IAM policies created and maintained by AWS. These included policies such as `AdministratorAccess`
  (full access to everything in an AWS account), `ReadOnlyAccess` (read-only access to everything in an AWS account),
  `AmazonEC2ReadOnlyAccess` (read-only access to solely EC2 resources in an AWS account), and many others.

Customer-managed policies::
  While managed policies give you coarse-grained, generic permissions, to get more fine-grained, custom permissions,
  you can create custom IAM policies (known as _customer-managed policies_).

Standalone policies::
  A _standalone policy_ is an IAM policy that exists by itself and can be attached to other IAM entities. For example,
  you could create a single policy that gives access to a specific S3 bucket and _attach_ that policy to several IAM
  users so they all get the same permissions.

Inline policies::
  An _inline policy_ is a policy that's embedded within an IAM entity, and only affects that single entity. For
  example, you could create a policy embedded within an IAM user that gives solely that one user access to a specific
  S3 bucket.

=== IAM groups

An _https://docs.aws.amazon.com/IAM/latest/UserGuide/id_groups.html[IAM group]_ is a collection of IAM users. You can
attach IAM policies to an IAM group and all the users in that group will inherit the permissions from that policy.
Instead of managing permissions by attaching multiple IAM policies directly to each IAM user—which can become very hard
to maintain as the number of policies and users grows and your organization changes—you can create a relatively fixed
number of groups that represent your company's structure and permissions (e.g., `developers`, `admins`, and `billing`)
and assign each IAM user to the appropriate IAM groups.

=== IAM roles

An _https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles.html[IAM role]_ is a standalone IAM entity that (a) allows
you to attach IAM policies to it, (b) specify which other IAM entities to trust, and then (c) those other IAM entities
can _assume_ the IAM role to be temporarily get access to the permissions in those IAM policies. The two most common
use cases for IAM roles are:

Service roles::
  Whereas an IAM user allows a human being to access AWS resources, one of the most common use cases for an IAM role is
  to allow a service—e.g., one of your applications, a CI server, or an AWS service—to access specific resources in
  your AWS account. For example, you could create an IAM role that gives access to a specific S3 bucket and allow that
  role to be assumed by one of your EC2 instances. The code running on that EC2 instance will then be able to access
  that S3 bucket without you having to manually copy AWS credentials (i.e., access keys) onto that instance.

Cross account access::
  Another common use case for IAM roles is to grant an IAM entity in one AWS account access to specific resources in
  another AWS account. For example, if you have an IAM user in account `A`, then by default, that IAM user cannot
  access anything in account `B`. However, you could create an IAM role in account `B` that gives access to a specific
  S3 bucket in account `B` and allow that role to be assumed by an IAM user in account `A`. That IAM user will then be
  able to access the contents of the S3 bucket by assuming the IAM role in account `B`.

Here are some more details on how IAM roles work:

IAM policies::
  Just as you can attach IAM policies to an IAM user and IAM group, you can attach IAM policies to an IAM role.

Trust policy::
  You must define a _trust policy_ for each IAM role, which is a JSON document (very similar to an IAM policy) that
  specifies who can assume this IAM role. For example, here is a trust policy that allows this IAM role to be assumed
  by an IAM user named `Bob` in AWS account `111122223333`:
+
[source,json]
----
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {"AWS": "arn:aws:iam::111122223333:user/Bob"},
      "Action": "sts:AssumeRole"
    }
  ]
}
----

Assuming an IAM role::
  IAM roles do not have a user name, password, or permanent access keys. To use an IAM role, you must _assume_ it by
  making an `AssumeRole` API call (see the
  https://docs.aws.amazon.com/STS/latest/APIReference/API_AssumeRole.html[AssumeRole API] and
  https://docs.aws.amazon.com/cli/latest/reference/sts/assume-role.html[assume-role CLI command]), which will return
  _temporary access keys_ you can use in follow-up API calls to authenticate as the IAM role (the temporary access keys
  will be valid for 1-12 hours, depending on IAM role settings, after which you must call `AssumeRole` again to fetch
  new keys). Note that to make the `AssumeRole` API call, you must first authenticate to AWS using some other
  mechanism. For example, for an IAM user to assume an IAM role, you:
+
. Authenticate using the IAM user's permanent AWS access keys
. Make the `AssumeRole` API call
. AWS sends back temporary access keys
. You authenticate using those temporary access keys
. Now all of your subsequent API calls will be on behalf of the assumed IAM role, with access to whatever permissions
  are attached to that role

IAM roles and AWS services::
  Most AWS services have native support built-in for assuming IAM roles. For example, you can associate an IAM role
  directly with an EC2 instance, and that instance will automatically assume the IAM role every few hours, making the
  temporary credentials available in
  _https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html#instancedata-data-retrieval[EC2 instance metadata]_.
  Just about every AWS CLI and SDK tool knows how to read temporary credentials from EC2 instance metadata, so in
  practice, as soon as you attach an IAM role to an EC2 instance, any code running on that EC2 instance can
  automatically make API calls on behalf of that IAM role, with whatever permissions are attached to that role. This
  allows you to give code on your EC2 instances IAM permissions without having to manually figure out how to copy
  credentials (access keys) onto that instance! The same strategy works with many other AWS services: e.g., you use
  IAM roles as a secure way to give your Lambda functions, ECS services, Step Functions, and many other AWS services
  permissions to access specific resources in your AWS account.

=== Federated authentication

_https://aws.amazon.com/identity/federation/[Federation]_ allows you to authenticate to your AWS account using an
existing _identity provider (IdP)_, such as Google, Active Directory, or Okta, rather than IAM users. Since just about
every single company already has all their user accounts defined in an IdP, this allows you to avoid having to:

* Duplicate all those user accounts in the form of IAM users
* Maintain and update user accounts in multiple places (e.g., when someone changes teams or leaves the company)
* Manage multiple sets of credentials

There are several ways to configure your AWS account to support _single sign-on (SSO)_, allowing you to authenticate
using the users and credentials from your IdP:

AWS Single Sign-On::
  https://aws.amazon.com/single-sign-on/[AWS Single Sign-On] is a managed service that allows you to configure SSO for
  IdPs that support SAML, such as Active Directory and Google. It provides a simple SSO experience for the AWS web
  console, although
  https://aws.amazon.com/blogs/security/aws-single-sign-on-now-enables-command-line-interface-access-for-aws-accounts-using-corporate-credentials/[signing in on the command line]
  requires multiple steps, including manually copy/pasting credentials.

Gruntwork Houston::
  Gruntwork Houston allows you to configure SSO for IdPs that support SAML or OAuth, including Active Directory,
  Google, Okta, GitHub, and others. It provides a simple SSO experience for the AWS web console, command-line access,
  VPN access, and SSH access. Houston is currently in private beta, so if you're interested, please
  mailto:info@gruntwork.io[email us to find out how to get access].

=== AWS Organizations

_https://aws.amazon.com/organizations/[AWS Organizations]_ gives you a central way to manage multiple AWS accounts. As
you'll see in <<production_grade_design>>, you'll need to use multiple separate AWS accounts to manage separate
environments, and AWS organizations is the best way to create and manage all of those accounts.

Root account::
  The first AWS account you create is the _root account_ (sometimes also called the _master account_). This will be the
  parent account for your organization. This account has powerful permissions over all child accounts, so you should
  strictly limit access to this account to a small number of trusted admins.

Child account::
  You can use AWS Organizations to create one or more _child accounts_ beneath the root account.

Organization unit::
  You can group child accounts into one or more _organization units_. This gives you a logical way to group accounts:
  for example, if your company has multiple business units, then each business unit could be represented by one
  organization unit, and each organization unit can contain multiple child accounts that can be accessed solely by
  members of that business unit.

Consolidated billing::
  All of the billing from the child accounts rolls up to the root account. This allows you to manage all payment
  details in a single account and to get a breakdown of cost by organization unit, child account, service type, etc.

IAM roles::
  When creating a child account, you can configure AWS Organizations to create an IAM role within that account that
  allow users from the root account to access the child account. This allows you to manage the child accounts from the
  parent account without having to create an IAM user in every single child account.

Service control policies::
  You can use
  _https://docs.aws.amazon.com/organizations/latest/userguide/orgs_manage_policies_scp.html[Service control policies (SCPs)]_
  to define the maximum available permissions for a child account, overriding any permissions defined in the child
  account itself. For example, you could use SCPs to completely block a child account from using specific AWS services
  (e.g., Redshift or Amazon Elasticsearch), perhaps because those services do not meet your company's compliance
  requirements (e.g., PCI, HIPAA, etc).

=== CloudTrail

_https://aws.amazon.com/cloudtrail/[AWS CloudTrail]_ is a service you can use to log (most) of the activity within your
AWS account. CloudTrail automatically maintains an audit log of all API calls for
https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-aws-service-specific-topics.html[supported services]
in your AWS account, writing these logs to an S3 bucket, and optionally encrypting the data using
https://aws.amazon.com/kms/[KMS]. It can be a good idea to enable CloudTrail in every AWS account, as the API call
data is useful useful for troubleshooting, investigating security incidents, and maintaining audit logs for compliance.

=== AWS Config

Whereas CloudTrail maintains a log of API calls, _https://aws.amazon.com/cloudtrail/[AWS Config]_ is a service that
maintains a log of the resource configurations that were the result of those API calls. This allows you to see, for
example, how your EC2 instances or security groups were configured at some snapshot in time, as well as the
relationships between those resources. AWS Config can also compare the resource configurations against a set of
https://docs.aws.amazon.com/config/latest/developerguide/evaluate-config.html[rules you define] (e.g., you can define
rules that check compliance requirements) and notify you if those rules are being violated.

=== Amazon GuardDuty

_https://aws.amazon.com/guardduty/[Amazon GuardDuty]_ is a service that can automatically detect threats and anomalies
in your AWS account. GuardDuty continuously monitors activity from AWS data sources, such as AWS CloudTrail, Amazon
VPC Flow Logs, and DNS logs, analyzes it using rule sets and machine learning, and triggers an alert if it detects
malicious or unauthorized behavior.

[[production_grade_design]]
== Production-grade design

With all the core concepts out of the way, let's now discuss how to configure a production-grade AWS account structure
that looks something like this:

.A production-grade AWS account structure
image::../assets/img/guides/aws-account/aws-account-structure.png[]

// TODO: other topics we may wish to cover:
// Compliance: e.g., signing BAA for HIPAA https://aws.amazon.com/artifact/?nc2=h_m1
// A separate "backup" account for disaster recovery

=== Root account

The first step is to create your root account. This account will be the parent of all of your other AWS accounts and
the central place where you manage billing:

. Go to https://aws.amazon.com.
. Click Create an AWS Account.
. Go through the sign up flow, entering contact and billing details as requested.
. You will be asked to enter an email address and password to use as the credentials for the root user of this root
  account. Let's now turn our attention to how to handle this password and other security considerations for the root
  user.

[[lock_down_root_user]]
=== Lock down a root user

The root user has unrestricted access to just about everything in your AWS account (and any child accounts),
so if an attacker compromises your root user, the results can be catastrophic for your company. Therefore, it's
critical that you lock this root user down as much as possible:

Use a secrets manager::
  Do NOT store the credentials or any kind of secret in plain text. Instead, always use a secrets manager such as
  https://1password.com[1Password], https://www.lastpass.com[LastPass], or https://www.passwordstore.org[pass] to store
  the credentials in an encrypted format.

Use a strong, generated password::
  Do NOT re-use passwords from other websites, or any password that you can remember at all. Instead, generate a random,
  cryptographically secure, long password (20+ characters). All the password managers mentioned above can generate and
  store passwords for you in one step, so use them!

Enable MFA::
  Always make sure to
  https://docs.aws.amazon.com/IAM/latest/UserGuide/id_root-user.html#id_root-user_manage_mfa[enable MFA for your root user].
  Feel free to use a virtual or hardware MFA device—whichever is easier or required by your company—as either one
  dramatically improves the security of your root user.

Disable access keys::
  Right after enabling MFA, make sure to
  https://docs.aws.amazon.com/IAM/latest/UserGuide/id_root-user.html#id_root-user_manage_delete-key[delete the root user's access keys],
  so that the only way to login as the root user is via the web console, where MFA is required.

Create an Admin IAM user::
  Now that the root user is locked down, the next step is to
  https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users_create.html[create an IAM user] and to attach admin
  permissions to this user. Later on, you'll be able to create all IAM users using code and assign permissions using
  IAM groups, but for this very first user, your best bet is to do it manually by using the web console to directly
  attach the `AdministratorAccess` managed policy to this user.

Don't use the root user again::
  From here on out, you should only use the IAM user account, and more or less never touch the root user account again.
  The only time you'll need it is for account recovery situations (e.g., you accidentally deleted the IAM user or lost
  your credentials) or for the
  https://docs.aws.amazon.com/general/latest/gr/aws_tasks-that-require-root.html[small number of tasks that require root user credentials].

The first step in using your new IAM user is to lock that user down!

[[lock_down_iam_user]]
=== Lock down an IAM user

Although IAM users don't have the same powers as a root user, having an IAM user account compromised can still be a
huge problem for your company (especially if that IAM user had admin permissions), so it's still critical to lock down
IAM user accounts as much as possible:

Use a secrets manager::
  Do NOT store the credentials or any kind of secret in plain text. Instead, always use a secrets manager such as
  https://1password.com[1Password], https://www.lastpass.com[LastPass], or https://www.passwordstore.org[pass] to store
  the credentials in an encrypted format.

Use a strong, generated password::
  Do NOT re-use passwords from other websites, or any password that you can remember at all. Instead, generate a random,
  cryptographically secure, long password (20+ characters). All the password managers mentioned above can generate and
  store passwords for you in one step, so use them!

Enable MFA::
  Always make sure to
  https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_mfa_enable.html[enable MFA for your IAM user].
  Feel free to use a virtual or hardware MFA device—whichever is easier or required by your company—as either one
  dramatically improves the security of your IAM user. Note that using SMS (text messages) for MFA is
  https://www.schneier.com/blog/archives/2016/08/nist_is_no_long.html[no longer recommended by NIST] due to known
  https://www.theverge.com/2017/9/18/16328172/sms-two-factor-authentication-hack-password-bitcoin[vulnerabilities with the cellular system],
  so using a virtual or hardware MFA device is preferable; that said, MFA with SMS is still better than no MFA at all!

=== Child accounts

Now that you have your root account setup, you can use AWS Organizations to create all the child accounts. The exact
child accounts you will need will vary depending on your company's needs, but the overall structure should look
something like this:

.A production-grade AWS account structure
image::../assets/img/guides/aws-account/aws-account-structure.png[]

Let's break down the accounts in this diagram:

Security account::
  You will want a single _security account_ where all of your IAM users and IAM groups are defined. So, even though
  our account structure has multiple accounts, each person on your team will have only a single IAM user and a single
  set of credentials (the one exception is the root account, where one or a small number of admins will have a separate
  IAM user and separate credentials used to manage the account structure itself). The security account is not used to
  run any infrastructure, bot solely a central place to manage authentication and authorization.

Application accounts (dev, stage, prod)::
  You can have one or more _application accounts_ for running your software. At a bare minimum, most companies will
  have a production account ("prod"), for running user-facing software, and a staging account ("stage") which is a
  replica of production (albeit with smaller or fewer servers to save money) used for internal testing. Some teams will
  have more pre-prod environments (e.g., dev, qa, uat) and some may find the need for more than one prod account (e.g.,
  a separate failover account for disaster recovery).

Shared-services account::
  The _shared-services account_ is used to store infrastructure and data that is shared amongst all the application
  accounts, such as CI servers and artifact repositories. For example, in your shared-services account, you might use
  https://aws.amazon.com/ecr/[ECR] to store Docker images and Jenkins to deploy those Docker images to dev, stage, and
  prod.

Sandbox accounts::
  You may want to have one or more _sandbox accounts_ that developers can use for manual testing. The application
  accounts (e.g., dev and stage) are usually shared by the whole company, so these sandbox accounts are intentionally
  kept separate so that developers can feel comfortable deploying and undeploying anything they want without
  fear of affecting someone else (in fact, the gold standard is one sandbox account per developer to keep things 100%
  isolated). Sandbox accounts tend to build up more and more unused infrastructure over time, so to prevent your bill
  from getting out of hand, you may want to run a tool like https://github.com/gruntwork-io/cloud-nuke[cloud-nuke] on
  a daily basis to clean up everything in the account older than, say, 5 days (you wouldn't want to run a tool like
  `cloud-nuke` in an account like staging, so this is yet another reason to keep sandbox accounts separate).

Testing accounts::
  One other type of account that often comes in handy is a _testing account_ that is used specifically for automated
  tests that spin up and tear down lots of AWS infrastructure. For example, at Gruntwork, we use
  https://blog.gruntwork.io/open-sourcing-terratest-a-swiss-army-knife-for-testing-infrastructure-code-5d883336fcd5[Terratest]
  to test all of our infrastructure code, and when testing something like our
  https://github.com/hashicorp/terraform-aws-vault/[Vault modules], we end up spinning up and tearing down a dozen
  Vault and Consul clusters after every single commit! You don't want all this infrastructure churn in your application
  or sandbox accounts, so we recommend having a separate AWS account dedicated for automated tests. This is especially
  important as automated tests sometimes fail to clean up that infrastructure (e.g., due to a bug in the test or the
  test crashing before it can run the cleanup steps), so you'll want to run a tool like `cloud-nuke` multiple times per
  day to clean up anything older than a few hours, which you definitely don't want in your application or sandbox
  accounts.

Note that for larger organizations with multiple separate business units, you may need to repeat the structure above
multiple times. That is, in the root account, you
https://docs.aws.amazon.com/organizations/latest/userguide/orgs_manage_ous.html#create_ou[create an Organization Unit]
for each business unit, and within each Organization Unit, you create the security, dev, stage, prod,
shared-services, sandbox, and testing accounts.

Here are a few useful tips on creating child accounts:

Use AWS Organizations::
  Use AWS Organizations to https://docs.aws.amazon.com/organizations/latest/userguide/orgs_manage_accounts_create.html[create each child account].
  If there are certain AWS services that should never be used in the child accounts (e.g., because the service does not
  meet your company's compliance requirements),
  https://docs.aws.amazon.com/organizations/latest/userguide/orgs_manage_policies_scp.html[create an SCP] that prevents
  that service from being used.

IAM roles in child accounts::
  As you're creating each account, AWS Organizations will ask you for the name of an IAM role to create in the child
  account. This IAM role will allow you to access the child account from the root account with full administrative
  access, which is a useful fallback in case you accidentally lose access to the child account. We recommend using a
  consistent name for this IAM role, such as `OrganizationAccountAccessRole`, so you always know what role to assume
  when you need to access that account.

Unique root user email addresses::
  AWS requires that you associate an email address with each child account. This email address must be globally unique,
  so it cannot be the email address you used for the root account or any of the other child accounts. You'll have to
  either create multiple email accounts in your company's email system, or, if your company uses Gmail (perhaps as part
  of G Suite) for email, you can take advantage of the fact that
  https://gmail.googleblog.com/2008/03/2-hidden-ways-to-get-more-from-your.html[Gmail ignores everything after a plus sign in an email address],
  so that while AWS will see `example@gmail.com`, `example+dev@gmail.com`, `example+stage@gmail.com`, and
  `example+prod@gmail.com` as four unique email addresses, Gmail will see them all as the same email address,
  `example@gmail.com`.

Resetting the root user password::
  When you create a child account using AWS Organizations, you are asked to provide the email address for the root user,
  but confusingly, not a password. So how do you login as the root user then? It turns out that you need to
  https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_access-keys_retrieve.html#reset-root-password[reset the root user password],
  using the "Forgot your password?" prompt on the login page. AWS will email you a reset link and you'll be able to
  configure a password for the root user of this child account. As soon as you've reset the password, make sure to
  follow the steps in <<lock_down_root_user>>.

=== Lock down the root account root user

TODO

- Do this for each account
- Reset password
- Long, auto generated password in secrets mgr of trusted admin
- MFA
- Remove access keys
- Don't use again except in emergency / recover situations

=== IAM roles for users

- Roles in dev, stage, prod, shared
- Trust security acccount
- Require MFA <-----
- Common ones: allow-full-access-from-other-accounts, allow-read-only-from-other-accounts, allow-developers-from-other-accounts

=== IAM users and groups

TODO

- Create users in security acct
- At least user self-mgmt
- Require MFA for all of security acct?
- Alternatively, federated auth
    - Relies on similar IAM roles in each account
- Create groups with access to other accounts (don't assign policies directly to users)
    - Must connect from both sides
- security-full-access is solely for admins in security account; could be purely IAM permissions in that group
- Give no other permissions within security account itself

=== Password policy

- Enable in each account
- Follow NIST recommendations or compliance requirements

=== IAM roles for services

- IAM roles for services do not require MFA
- Trust policy only allows them to be assumed by specific service (e.g., ec2)
    - E.g., IAM role that allows Jenkins to deploy in this acct
    - E.g., IAM role that allows pushing to ECR
- If using external CI system, can't use IAM role, so create machine user, give access keys to that service
    - Will assume IAM role that doesn't require MFA
    - Be careful!
- Use ip-lockdown when possible

=== CloudTrail, AWS Config, Amazon GuardDuty

- Enable in each account
- Send data to security account and encrypt
- Only give admins access to KMS key

[[deployment_walkthrough]]
== Deployment walkthrough

TODO

- Creating accounts using code
- Switching between accounts
- Authenticating on the web
- Authenticating on the CLI
- Use unique email address for each user; see Google trick with the `+` thing.
- Reset root user password with AWS Org
- ip-lockdown for IAM roles
- SCPs

[[next_steps]]
== Next steps

TODO
